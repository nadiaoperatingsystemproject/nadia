#define KEYBOARD
#include "include/keyboard.h"
#include "include/kprint.h"
#include "../include/string.h"


unsigned char scanCode[] = {
					  0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,		/*esc*/
					  0x31, 0x21,0x21,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x32, 0x40,0x40,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x33, 0x23,0x23,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x34, 0x24,0x24,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x35, 0x25,0x25,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x36,0x5e,0x5e,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x37,0x26,0x26,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x38,0x2a,0x2a,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x39,0x28,0x28,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x30,0x29,0x29,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x2D,0x5f,0x5f,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x3D,0x2B,0x2B,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x09,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x71,0x51,0x51,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x77,0x57,0x57,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x65,0x45,0x45,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x72,0x52,0x52,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x74,0x54,0x54,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x79,0x59,0x59,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x75,0x55,0x55,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x69,0x49,0x49,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x6f,0x4f,0x4f,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x70,0x50,0x50,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x5b,0x7b,0x7b,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x5d,0x7d,0x7d,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x61,0x41,0x41,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x73,0x53,0x53,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x64,0x44,0x44,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x66,0x46,0x46,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x67,0x47,0x47,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x68,0x48,0x48,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x6a,0x4a,0x4a,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x6b,0x4b,0x4b,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x6c,0x4c,0x4c,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x3b,0x3a,0x3a,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x27,0x22,0x22,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x60,0x7e,0x7e,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x5c,0x7c,0x7c,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x7a,0x5a,0x5a,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x78,0x58,0x58,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x63,0x43,0x43,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x76,0x56,0x56,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x62,0x42,0x42,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x6e,0x4e,0x4e,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x6d,0x4d,0x4d,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x2c,0x3c,0x3c,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x2e,0x3e,0x3e,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x2f,0x3f,0x3f,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x2a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,				/* caplock */
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					  
					  

						};

unsigned char* currentscanCode;
unsigned char bufchr;
unsigned char reg_in;
unsigned char kbdDefined = KEYBOARD_NO_DEFINE;

extern void write_console(unsigned char c);

static unsigned char* get_kbd(){
	return currentscanCode;
}

static void set_kbd(unsigned char type){
	switch(type){
		case 0x1:
			currentscanCode = scanCode;
			break;
	}
}

unsigned char getchar(void){
	unsigned char c;
	do{

	}while(reg_in!=1);
	done:
	c = bufchr;
	bufchr = 0;
	reg_in = 0;
	return c;
}

static unsigned char load_kbd(unsigned char scan){
	unsigned char* keyScanCode;
	keyScanCode = get_kbd();
	return load_char(keyScanCode, scan);
}

static unsigned char load_char(unsigned char* keyScanCode, unsigned char scan){
	/* 
		no-control : 				0000000000000000		0x00
		Left_shift-control : 		0000000000000001		0x01
		Right_shift-control : 		0000000000000010		0x02
		Left_ctrl-control : 		0000000000000100		0x03
		Right_ctrl-control : 		0000000000001000		0x04
		Atl-control : 				0000000000010000		0x05
		AtlGr-control : 			0000000000100000		0x06
		capLock-control : 			0000000001000000		0x07
		numLock-control : 			0000000010000000		0x08
	*/
	struct ctrl_key_struct* strt_keyctrl = &key_controller; 
	static unsigned short channel_kbd  = 0;
	channel_kbd = (unsigned short) (strt_keyctrl->lshift + strt_keyctrl->rshift + strt_keyctrl->lctrlkey + strt_keyctrl->rctrlkey + strt_keyctrl->altkey + strt_keyctrl->altGrkey + strt_keyctrl->caplock + strt_keyctrl->numlock);
	
	return keyScanCode[9*(scan-1)+channel_kbd];
			
}


static void set_fn_key(struct ctrl_key_struct* strt_keyctrl, unsigned char index, unsigned char val){
	switch(index){
		case 0x1:
			strt_keyctrl->lshift = val;
			break;
		case 0x2:
			strt_keyctrl->rshift = val;
			break;
		case 0x3:
			strt_keyctrl->lctrlkey = val;
			break;
		case 0x4:
			strt_keyctrl->rctrlkey = val;
		case 0x5:
			strt_keyctrl->altkey = val;
			break;
		case 0x6:
			strt_keyctrl->altGrkey = val;
			break;
		case 0x7:
			strt_keyctrl->caplock = val;
			break;
		case 0x8:
			strt_keyctrl->numlock = val;
			break;
	}
}

static unsigned char fn_key_controller(struct ctrl_key_struct* strt_keyctrl, unsigned char key){
	static unsigned char key_cap_lock =0, key_num_lock =0, key_2nd_ctrl =0;
	if (key == 0xe0)
	{
		/* code */
		++key_2nd_ctrl;
		return 10;
	}
	if (key != 0xe0 && key_2nd_ctrl == 0){
		if (key == 0x2a || key == 0xaa){		/* CTRL LEFT KEY*/
			if (key == 0x2a)
				set_fn_key(strt_keyctrl, 1, LSHIFT_KEY_ACTIVE);
			else
				set_fn_key(strt_keyctrl, 1, KEY_NOACTIVE);
			return 1;
		}
		else if (key == 0x36 || key == 0xb6){		/* CTRL RIGHT KEY*/
			if (key == 0x36)
				set_fn_key(strt_keyctrl, 2, RSHIFT_KEY_ACTIVE);
			else
				set_fn_key(strt_keyctrl, 2, KEY_NOACTIVE);
			return 2;
		}
		else if (key == 0x1d || key == 0x9d){
			if (key == 0x1d)
				set_fn_key(strt_keyctrl, 3, LCTRL_KEY_ACTIVE);
			else
				set_fn_key(strt_keyctrl, 3, KEY_NOACTIVE);
			return 3;
		}
		else if (key == 0x38 || key == 0xb8){
			if (key == 0x38)
				set_fn_key(strt_keyctrl, 5, ALT_KEY_ACTIVE);
			else
				set_fn_key(strt_keyctrl, 5, KEY_NOACTIVE);
			return 4;
		}
		else if (key == 0x3a || key == 0xba){
			if(key == 0x3a){
				if (key_cap_lock == 0){
					set_fn_key(strt_keyctrl, 7, CAPLOCK_KEY_ACTIVE);
					++key_cap_lock;
				}else{
					set_fn_key(strt_keyctrl, 7, KEY_NOACTIVE);
					--key_cap_lock;
				}
			}
			return 5;
		}
		else if (key == 0x45 || key == 0xc5){
			if (key_num_lock == 0){
				set_fn_key(strt_keyctrl, 8, NUMLOCK_KEY_ACTIVE);
				++key_num_lock;
			}else{
				set_fn_key(strt_keyctrl, 8, KEY_NOACTIVE);
				--key_num_lock;
			}
			return 5;
		}
	}
	else if(key_2nd_ctrl){
		
		if (key == 0x1d || key == 0x9d){
			if (key == 0x1d){
				set_fn_key(strt_keyctrl, 4, RCTRL_KEY_ACTIVE);
			}
			else{
				set_fn_key(strt_keyctrl, 4, KEY_NOACTIVE);
			}
			key_2nd_ctrl=0;
			return 6;
		}
		else if (key == 0x38 || key == 0xb8){
			if (key == 0x38){
				set_fn_key(strt_keyctrl, 6, ALTGR_KEY_ACTIVE);
			}
			else{
				set_fn_key(strt_keyctrl, 6, KEY_NOACTIVE);
			}
			key_2nd_ctrl=0;
			return 7;
		}
		
	}
	return 0;
}


static void kbd_callback(registers_t reg){
	unsigned char scan_code,ctrl;
	unsigned char* str;
	scan_code = read_input_port_kbd();
	ctrl = fn_key_controller(&key_controller, scan_code);
	if (kbdDefined != KEYBOARD_DEFINE)
	{
		/* code */
		set_kbd(TYPE_KEYBOARD_EN);
		kbdDefined = KEYBOARD_DEFINE;
	}
	if (ctrl){
		if (ctrl < 10)
		{
			/* code allow to change type keyboard */
		
			/*switch(ctrl){
				case 0x1:
					strt_keyctrl->lshift = val;
					break;
				case 0x2:
					strt_keyctrl->rshift = val;
					break;
				case 0x3:
					strt_keyctrl->lctrlkey = val;
					break;
				case 0x4:
					strt_keyctrl->rctrlkey = val;
				case 0x5:
					strt_keyctrl->altkey = val;
					break;
				case 0x6:
					strt_keyctrl->altGrkey = val;
					break;
				case 0x7:
					strt_keyctrl->caplock = val;
					break;
				case 0x8:
					strt_keyctrl->numlock = val;
					break;
			}*/
			
		}
	}
	else{
		if(scan_code<0x80)

			if(!reg_in){
				bufchr = load_kbd(scan_code);
				reg_in = 1;
			}
	}

	
}

/* init device */ 
static void config_device_keyboard(void){
	unsigned char a=0, b=0;
	 disable_kbd();				/* Disable keyboard device */
	cmd_read_port_kbd();
	a = read_input_port_kbd();							/* read data in output port */ 
	cmd_write_port_kbd();
	write_output_port_kbd(a);						/* send command to write data in output port */ 
	enable_kbd();
	kprint("\n [+] KEYBOARD DRIVER INIT -------------- [ ok ]\n");
}

void init_keyboard_driver(void){
	config_device_keyboard();
	register_int_handler(IRQ1,&kbd_callback);
	reg_in = 0;
}

static void set_led_kbd(unsigned char a, unsigned char b, unsigned char c){

}

static void set_self_test_kbd(void){

}

static void set_interface_test_kbd(void){

}

/* == ENABLE KEYBOARD ==*/

static void enable_kbd(){
	wait_input_buf_empty();		/* test if buffer input is full */
	outb(KBD_SEND_CMD_PORT, KBD_ENABLE);					/* send command to enable A20 line */ 
	wait_input_buf_empty();		/* test if buffer input is full */
}

/* == DISABLE KEYBOARD ==*/

static void disable_kbd(){
	wait_input_buf_empty();		/* test if buffer input is full */
	outb(KBD_SEND_CMD_PORT, KBD_DISABLE);
}

static void cmd_read_port_kbd(){
	wait_input_buf_empty();		/* test if buffer input is full */
	outb(KBD_SEND_CMD_PORT, KBD_READ_OUTPUT_PORT);		/* send command to read output port */ 
}

static unsigned char read_input_port_kbd(){
	unsigned char b;
	wait_output_buf_empty();	/* test if buffer output is empty */
	b = inb(KBD_READ_BUFFER_PORT);
	return b;
}

static void cmd_write_port_kbd(){
	wait_input_buf_empty();		/* test if buffer input is full */
	outb(KBD_SEND_CMD_PORT, KBD_WRITE_OUTPUT_PORT);		/* send command to read output port */ 
}

static void write_output_port_kbd(unsigned char a){
	unsigned char d;
	wait_input_buf_empty();		/* test if buffer input is full */
	d = a|2;
	outb(KBD_WRITE_BUFFER_PORT,d);
}


static void system_reset(){

}

void cleanbufkbd(void){
	if(reg_in)
		reg_in = 0;
	bufchr = 0;
}
